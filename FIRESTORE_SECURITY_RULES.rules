rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================================
    // PRODUCTS COLLECTION - PhoneDB
    // ===========================================
    // Cho phép tất cả user đọc sản phẩm (public access)
    // Chỉ admin hoặc authenticated users mới có thể thêm/sửa/xóa
    match /PhoneDB/{productId} {
      allow read: if true; // Public read access for product catalog
      allow write: if request.auth != null; // Only authenticated users can modify
    }
    
    // ===========================================
    // CART COLLECTION
    // ===========================================
    // User chỉ có thể truy cập cart của chính họ
    match /carts/{cartItemId} {
      // Đọc cart items của user hiện tại
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      
      // Tạo cart item mới (userId phải khớp với user hiện tại)
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId &&
                       validateCartItem(request.resource.data);
      
      // Cập nhật cart item (chỉ được thay đổi quantity, updatedAt)
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId &&
                       validateCartItemUpdate(request.resource.data, resource.data);
      
      // Xóa cart item của chính user
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // ===========================================
    // USER PROFILES COLLECTION
    // ===========================================
    // User chỉ có thể truy cập profile của chính họ
    match /users/{userId} {
      allow read, write: if request.auth != null && 
                           request.auth.uid == userId;
      allow create: if request.auth != null && 
                      request.auth.uid == userId;
    }
    
    // ===========================================
    // ORDERS COLLECTION (Future expansion)
    // ===========================================
    match /orders/{orderId} {
      allow read, write: if request.auth != null && 
                           request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
                      request.auth.uid == request.resource.data.userId;
    }
    
    // ===========================================
    // ADMIN COLLECTIONS (Optional)
    // ===========================================
    // Chỉ admin users mới có thể truy cập
    match /admin/{document=**} {
      allow read, write: if request.auth != null && 
                           isAdmin(request.auth);
    }
    
    // ===========================================
    // DEFAULT DENY ALL
    // ===========================================
    // Từ chối tất cả các collection khác không được định nghĩa
    match /{document=**} {
      allow read, write: if false;
    }
  }
  
  // ===========================================
  // HELPER FUNCTIONS
  // ===========================================
  
  // Kiểm tra xem user có phải admin không
  function isAdmin(auth) {
    return auth != null && 
           auth.token.admin == true;
  }
  
  // Validate cart item data structure
  function validateCartItem(data) {
    return data.keys().hasAll(['userId', 'productId', 'productName', 'quantity', 'addedAt']) &&
           data.userId is string &&
           data.productId is string &&
           data.productName is string &&
           data.quantity is number &&
           data.quantity > 0 &&
           data.quantity <= 99 && // Max quantity limit
           data.addedAt is timestamp;
  }
  
  // Validate cart item update (chỉ cho phép thay đổi quantity và updatedAt)
  function validateCartItemUpdate(newData, existingData) {
    return newData.userId == existingData.userId &&
           newData.productId == existingData.productId &&
           newData.productName == existingData.productName &&
           newData.quantity is number &&
           newData.quantity > 0 &&
           newData.quantity <= 99 &&
           newData.updatedAt is timestamp;
  }
}